#
#
#
variables: 
  test_tag: '2023.01.01.009.ra.gs.tt.n51.ab'

stages:          # List of stages for jobs, and their order of execution
  - preBuild1
  - preBuild2
  - build
  - deploy

show_variables: 
  stage: preBuild1
  tags:
    - gitlab-shared-runner
  script: 
    - echo $CI_COMMIT_REF_NAME
    - echo $CI_COMMIT_TAG
    - echo $test
    - echo $test_tag

testProd: 
  stage: preBuild2
  tags: 
    - gitlab-shared-runner
  only: 
    refs: 
      - develop
    variables: 
      - $CI_COMMIT_REF_NAME =~ /ra/ || $test_tag =~/ra/
  script: 
    - echo ' i am testProd'  


build-gs-job:       # This job runs in the build stage, which runs first.
  stage: build
  tags:
    - gitlab-shared-runner
  only:
    refs:
      - develop
  script:
    - docker build -f Dockerfile --build-arg env=dev --build-arg scope=app_gs -t asia-east2-docker.pkg.dev/wgp-project-337610/wgp-video/${CI_PROJECT_NAME}:dev .
    - gcloud auth print-access-token | docker login -u oauth2accesstoken --password-stdin asia-east2-docker.pkg.dev
    - docker push asia-east2-docker.pkg.dev/wgp-project-337610/wgp-video/${CI_PROJECT_NAME}:dev
    - echo "Compile complete."

build-tt-job:       # This job runs in the build stage, which runs first.
  stage: build
  tags:
    - gitlab-shared-runner
  only:
    refs:
      - develop
  allow_failure: true
  script:
    - docker build -f Dockerfile --build-arg env=dev --build-arg scope=app_tt -t asia-east2-docker.pkg.dev/wgp-project-337610/wgp-video/${CI_PROJECT_NAME}-tt:dev .
    - gcloud auth print-access-token | docker login -u oauth2accesstoken --password-stdin asia-east2-docker.pkg.dev
    - docker push asia-east2-docker.pkg.dev/wgp-project-337610/wgp-video/${CI_PROJECT_NAME}-tt:dev
    - echo "Compile complete."

build-51ss-job:       # This job runs in the build stage, which runs first.
  stage: build
  tags:
    - gitlab-shared-runner
  only:
    refs:
      - develop
  allow_failure: true
  script:
    - docker build -f Dockerfile --build-arg env=dev --build-arg scope=app_51ss -t asia-east2-docker.pkg.dev/wgp-project-337610/wgp-video/${CI_PROJECT_NAME}-51ss:dev .
    - gcloud auth print-access-token | docker login -u oauth2accesstoken --password-stdin asia-east2-docker.pkg.dev
    - docker push asia-east2-docker.pkg.dev/wgp-project-337610/wgp-video/${CI_PROJECT_NAME}-51ss:dev
    - echo "Compile complete."

build-ra-job:       # This job runs in the build stage, which runs first.
  stage: build
  tags:
    - gitlab-shared-runner
  only:
    refs:
      - develop
    #variables:
    #  - $youda =~ /^$/ || $youda =~ /ra/ || $test_tag =~/ra/
  allow_failure: true
  script:
    - docker build -f Dockerfile --build-arg env=dev --build-arg scope=app_ra -t asia-east2-docker.pkg.dev/wgp-project-337610/wgp-video/${CI_PROJECT_NAME}-ra:dev .
    - gcloud auth print-access-token | docker login -u oauth2accesstoken --password-stdin asia-east2-docker.pkg.dev
    - docker push asia-east2-docker.pkg.dev/wgp-project-337610/wgp-video/${CI_PROJECT_NAME}-ra:dev
    - echo "Compile complete."

build-ab-job:       # This job runs in the build stage, which runs first.
  stage: build
  tags:
    - gitlab-shared-runner
  only:
    refs:
      - develop
  allow_failure: true
  script:
    - docker build -f Dockerfile --build-arg env=dev --build-arg scope=app_ab -t asia-east2-docker.pkg.dev/wgp-project-337610/wgp-video/${CI_PROJECT_NAME}-ab:dev .
    - gcloud auth print-access-token | docker login -u oauth2accesstoken --password-stdin asia-east2-docker.pkg.dev
    - docker push asia-east2-docker.pkg.dev/wgp-project-337610/wgp-video/${CI_PROJECT_NAME}-ab:dev
    - echo "Compile complete."

build-sv-job:       # This job runs in the build stage, which runs first.
  stage: build
  tags:
    - gitlab-shared-runner
  only:
    refs:
      - develop
  allow_failure: true
  script:
    - docker build -f Dockerfile --build-arg env=dev --build-arg scope=app_sv -t asia-east2-docker.pkg.dev/wgp-project-337610/wgp-video/${CI_PROJECT_NAME}-sv:dev .
    - gcloud auth print-access-token | docker login -u oauth2accesstoken --password-stdin asia-east2-docker.pkg.dev
    - docker push asia-east2-docker.pkg.dev/wgp-project-337610/wgp-video/${CI_PROJECT_NAME}-sv:dev

deploy-gs-job:      # This job runs in the deploy stage.
  stage: deploy  # It only runs when *both* jobs in the test stage complete successfully.
  tags:
    - gitlab-shared-runner
  only:
    refs:
      - develop
  script:
    - echo "Deploying application..."
    - helm upgrade --kubeconfig /home/gitlab-runner/.kube/config-list/dev --install "${CI_PROJECT_NAME}" -f /home/gitlab-runner/hm-helm/helm-charts/stt/${CI_PROJECT_NAME}/values.yaml.dev --set global.release=$(echo "dev-`date +%F-%T`") /home/gitlab-runner/hm-helm/helm-charts/stt/${CI_PROJECT_NAME} -n video-dev
    - echo "Application successfully deployed."
  
deploy-tt-job:      # This job runs in the deploy stage.
  stage: deploy  # It only runs when *both* jobs in the test stage complete successfully.
  tags:
    - gitlab-shared-runner
  only:
    refs:
      - develop
  script:
    - echo "Deploying application..."
    - helm upgrade --kubeconfig /home/gitlab-runner/.kube/config-list/dev --install "${CI_PROJECT_NAME}-tt" -f /home/gitlab-runner/hm-helm/helm-charts/stt/${CI_PROJECT_NAME}-tt/values.yaml.dev --set global.release=$(echo "dev-`date +%F-%T`") /home/gitlab-runner/hm-helm/helm-charts/stt/${CI_PROJECT_NAME}-tt -n video-dev
    - echo "Application successfully deployed."

deploy-51ss-job:      # This job runs in the deploy stage.
  stage: deploy  # It only runs when *both* jobs in the test stage complete successfully.
  tags:
    - gitlab-shared-runner
  only:
    refs:
      - develop
  script:
    - echo "Deploying application..."
    - helm upgrade --kubeconfig /home/gitlab-runner/.kube/config-list/dev --install "${CI_PROJECT_NAME}-51ss" -f /home/gitlab-runner/hm-helm/helm-charts/stt/${CI_PROJECT_NAME}-51ss/values.yaml.dev --set global.release=$(echo "dev-`date +%F-%T`") /home/gitlab-runner/hm-helm/helm-charts/stt/${CI_PROJECT_NAME}-51ss -n video-dev
    - echo "Application successfully deployed."

deploy-ra-job:      # This job runs in the deploy stage.
  stage: deploy  # It only runs when *both* jobs in the test stage complete successfully.
  tags:
    - gitlab-shared-runner
  only:
    refs:
      - develop
    #variables:
    #  - $youda =~ /^$/ || $youda =~ /ra/ || $test_tag =~/ra/
  script:
    - echo "Deploying application..."
    - helm upgrade --kubeconfig /home/gitlab-runner/.kube/config-list/dev --install "${CI_PROJECT_NAME}-ra" -f /home/gitlab-runner/hm-helm/helm-charts/stt/${CI_PROJECT_NAME}-ra/values.yaml.dev --set global.release=$(echo "dev-`date +%F-%T`") /home/gitlab-runner/hm-helm/helm-charts/stt/${CI_PROJECT_NAME}-ra -n video-dev
    - echo "Application successfully deployed."

deploy-ab-job:      # This job runs in the deploy stage.
  stage: deploy  # It only runs when *both* jobs in the test stage complete successfully.
  tags:
    - gitlab-shared-runner
  only:
    refs:
      - develop
  script:
    - echo "Deploying application..."
    - helm upgrade --kubeconfig /home/gitlab-runner/.kube/config-list/dev --install "${CI_PROJECT_NAME}-ab" -f /home/gitlab-runner/hm-helm/helm-charts/stt/${CI_PROJECT_NAME}-ab/values.yaml.dev --set global.release=$(echo "dev-`date +%F-%T`") /home/gitlab-runner/hm-helm/helm-charts/stt/${CI_PROJECT_NAME}-ab -n video-dev
    - echo "Application successfully deployed."

deploy-sv-job:      # This job runs in the deploy stage.
  stage: deploy  # It only runs when *both* jobs in the test stage complete successfully.
  tags:
    - gitlab-shared-runner
  only:
    refs:
      - develop
  script:
    - echo "Deploying application..."
    - helm upgrade --kubeconfig /home/gitlab-runner/.kube/config-list/dev --install "${CI_PROJECT_NAME}-sv" -f /home/gitlab-runner/hm-helm/helm-charts/sv/${CI_PROJECT_NAME}/values.yaml.dev --set global.release=$(echo "dev-`date +%F-%T`") /home/gitlab-runner/hm-helm/helm-charts/sv/${CI_PROJECT_NAME} -n video-dev
    - echo "Application successfully deployed."

build-prod-job: 
  stage: build
  tags: 
    - gitlab-shared-runner
  only: 
    refs: 
      - tags
  script: 
    - PROJECT=$(echo $CI_COMMIT_REF_NAME | awk -F '.' '{print $NF}')
    - echo $PROJECT
    - docker build -f Dockerfile --build-arg env=prod --build-arg scope=app_$PROJECT -t asia-east2-docker.pkg.dev/wgp-project-337610/wgp-video/${CI_PROJECT_NAME}-$PROJECT:${CI_COMMIT_TAG} .
    - gcloud auth print-access-token | docker login -u oauth2accesstoken --password-stdin asia-east2-docker.pkg.dev
    - docker push asia-east2-docker.pkg.dev/wgp-project-337610/wgp-video/${CI_PROJECT_NAME}-$PROJECT:${CI_COMMIT_TAG}

build-gs-prod-job: 
  stage: build
  tags: 
    - gitlab-shared-runner
  only: 
    refs: 
      - tags
    variables: 
      - $CI_COMMIT_REF_NAME =~ /gs$/
  script: 
    - docker build -f Dockerfile --build-arg env=prod --build-arg scope=app_gs -t asia-east2-docker.pkg.dev/wgp-project-337610/wgp-video/${CI_PROJECT_NAME}:${CI_COMMIT_TAG} .
    - gcloud auth print-access-token | docker login -u oauth2accesstoken --password-stdin asia-east2-docker.pkg.dev
    - docker push asia-east2-docker.pkg.dev/wgp-project-337610/wgp-video/${CI_PROJECT_NAME}:${CI_COMMIT_TAG}

deploy-gs-prod-job: 
  stage: deploy
  tags: 
    - gitlab-shared-runner
  only: 
    refs: 
      - tags
    variables: 
      - $CI_COMMIT_REF_NAME =~ /gs$/
  script: 
    - helm upgrade --kubeconfig /home/gitlab-runner/.kube/config-list/gs --install ${CI_PROJECT_NAME} --wait --set global.release=${CI_COMMIT_TAG} --set global.image.tag=${CI_COMMIT_TAG} /home/gitlab-runner/hm-helm/helm-charts/stt/${CI_PROJECT_NAME} -n prod
    - /bin/bash /home/gitlab-runner/tg-notify.sh gs prod ${CI_PROJECT_NAME} ${CI_COMMIT_TAG}

deploy-sv-prod-job: 
  stage: deploy
  tags: 
    - gitlab-shared-runner
  only: 
    refs: 
      - tags
    variables: 
      - $CI_COMMIT_REF_NAME =~ /sv$/
  script: 
    - helm upgrade --kubeconfig /home/gitlab-runner/.kube/config-list/sv --install "${CI_PROJECT_NAME}-sv" --wait --set global.release=${CI_COMMIT_TAG} --set global.image.tag=${CI_COMMIT_TAG} /home/gitlab-runner/hm-helm/helm-charts/sv/${CI_PROJECT_NAME} -n prod
    - /bin/bash /home/gitlab-runner/tg-notify.sh sv prod ${CI_PROJECT_NAME} ${CI_COMMIT_TAG}

build-ab-prod-job: 
  stage: build
  tags: 
    - gitlab-shared-runner
  only: 
    refs: 
      - tags
    variables: 
      - $CI_COMMIT_REF_NAME =~ /ab$/
  script: 
    - docker build -f Dockerfile --build-arg env=prod --build-arg scope=app_ab -t asia-east2-docker.pkg.dev/wgp-project-337610/wgp-video/${CI_PROJECT_NAME}-ab:${CI_COMMIT_TAG} .
    - gcloud auth print-access-token | docker login -u oauth2accesstoken --password-stdin asia-east2-docker.pkg.dev
    - docker push asia-east2-docker.pkg.dev/wgp-project-337610/wgp-video/${CI_PROJECT_NAME}-ab:${CI_COMMIT_TAG}

deploy-ab-prod-job: 
  stage: deploy
  tags: 
    - gitlab-shared-runner
  only: 
    refs: 
      - tags
    variables: 
      - $CI_COMMIT_REF_NAME =~ /ab$/
  script: 
    - helm upgrade --kubeconfig /home/gitlab-runner/.kube/config-list/ab --install ${CI_PROJECT_NAME}-ab --wait --set global.release=${CI_COMMIT_TAG} --set global.image.tag=${CI_COMMIT_TAG} /home/gitlab-runner/hm-helm/helm-charts/stt/${CI_PROJECT_NAME}-ab -n prod
    - /bin/bash /home/gitlab-runner/tg-notify.sh ab prod ${CI_PROJECT_NAME}-ab ${CI_COMMIT_TAG}
